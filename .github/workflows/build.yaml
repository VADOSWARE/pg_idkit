name: build

on:
  workflow_call:
    inputs:
      artifact-name:
        type: string
        description: |
          Desired artifact name (will replace the natural name)
  push:

jobs:
  ## Build the project
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        # The version(s) of the Rust being used in the CI container
        # (requires building and pushing via `just build-ci-image push-ci-image`)
        rust_container_version:
          - 1.73

    container:
      image: ghcr.io/vadosware/pg_idkit/builder:0.1.x
      env:
        CARGO_HOME: /usr/local/cargo
        CARGO_TARGET_DIR: /usr/local/build/target
        SCCACHE_DIR: /usr/local/sccache
        CARGO_BUILD_RUSTC_WRAPPER: /usr/local/cargo/bin/sccache
        CARGO_INCREMENTAL: "0"
        CARGO_PROFILE: "ci"

    steps:
      # Checkout the repo
      - uses: actions/checkout@v3

      #########
      # Cache #
      #########

      - name: Cache CARGO_HOME
        uses: actions/cache@v2
        continue-on-error: false
        with:
          path: |
            /usr/local/cargo
          key: pg_idkit-tests-rust-${{ matrix.rust_container_version }}-cargo-${{ runner.os }}

      - name: Cache apt install
        uses: actions/cache@v2
        continue-on-error: false
        with:
          path: |
            /var/cache/apt
          key: pg_idkit-tests-apt-cache-${{ matrix.rust_container_version }}-cargo-${{ runner.os }}

      - name: Cache sccache
        uses: actions/cache@v2
        continue-on-error: false
        with:
          path: |
            /usr/local/sccache
          key: pg_idkit-tests-sccache-${{ matrix.rust_container_version }}-cargo-${{ runner.os }}

      ###############
      # Build/Tests #
      ###############

      - name: Add idkit to group
        run: |
          chgrp -R idkit $HOME &&
          chgrp -R idkit /__w/pg_idkit &&
          chmod g+w -R /__w/pg_idkit

      # Run cargo build
      - name: Run cargo test
        run: |
          su idkit -c "cargo build"

      # Run cargo check
      - name: Run cargo check
        run: |
          su idkit -c "cargo check"

      # Run cargo test
      - name: Run cargo test
        run: |
          su idkit -c "cargo test"

      #############
      # Artifacts #
      #############

      # Run cargo test
      - name: Build a package
        id: package
        if: ${{ github.event_name == 'workflow_call' }}
        run: |
          su idkit -c "just package"
          tar -cvf pg_idkit-$(just print-version).zip $(just print-pkg-output-dir)
          echo filename=pg_idkit-$(just print-version).zip >> $GITHUB_OUTPUT

      # Upload artifact
      - name: Upload artifact
        if: ${{ github.event_name == 'workflow_call' }}
        uses: actions/upload-artifact@v3
        with:
          name: ${{ inputs.artifact-name || steps.package.outputs.filename }}
          path: ${{ steps.package.outputs.filename }}

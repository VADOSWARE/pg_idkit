name: Build pg_idkit

on: [push]

jobs:
  ## Build the project
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        pg_version_major: [ "14" ]
        pg_version: [ "14.5" ]
        alpine_rust_package: [ "rust" ]
        alpine_rust_version: [ "1.63.0-r0" ]

    container:
      image: "postgres:${{ matrix.pg_version }}-alpine"
      options: --user postgres

    steps:
      # Checkout the repo
      - uses: actions/checkout@v3

      # Install deps (mostly for rust-cache)
      - name: Install dependencies
        run: |
          apk add nodejs g++ make musl-dev openssl openssl-dev rustup

      # Setup rust toolchain
      - name: Setup rust toolchain
        # run: /usr/bin/rustup-init toolchain install stable --profile minimal
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable

      # Install pgx
      - name: Install cargo-pgx
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-pgx

      # Setup cargo and rust cache
      - name: Setup cargo and rust cache
        uses: Swatinem/rust-cache@v2

      # Initialize pgx
      - name: Initialize pgx
        run: |
          cargo pgx init --pg${{ matrix.pg_version_major }} $(which pg_config)

      # Run cargo check
      - name: cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check

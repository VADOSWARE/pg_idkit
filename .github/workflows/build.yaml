name: Build pg_idkit

on: [push]

jobs:
  ## Build the project
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        rust_container_version: [ "1.63" ]
        alpine_postgresql_package: [ "postgresql14" ]
        alpine_postgresql_version: [ "14.5-r0" ]

    container:
      image: "rust:${{ matrix.rust_container_version }}-alpine"
      options: --user idkit

    steps:
      # Checkout the repo
      - uses: actions/checkout@v3

      # Setup rust toolchain
      #- name: Setup rust toolchain
      #  run: rustup toolchain install stable --profile minimal

      # Install deps (mostly for rust-cache)
      - name: Install dependencies
        run: |
          apk add nodejs musl-dev openssl openssl-dev \
            ${{ matrix.alpine_postgresql_package}}=${{ matrix.alpine_postgresql_version}}

      # Install pgx
      - name: Install cargo-pgx
        uses: actions-rs/cargo@v1
        with:
          command: install
          args: cargo-pgx

      # Setup cargo and rust cache
      - name: Setup cargo and rust cache
        uses: Swatinem/rust-cache@v2

      # Initialize pgx
      - name: Initialize pgx
        run: |
          cargo pgx init --pg14 $(which pg_config)

      # Run cargo check
      - name: cargo check
        uses: actions-rs/cargo@v1
        with:
          command: check
